CinerchApp.MovieSearchView=Backbone.View.extend({ENTER_KEY_CONSTANT:13,initialize:function(){this.currentMovieId=-1,this.render(),this.initializeAutoComplete()},render:function(){var e=_.template($("#movieSearchbox-tpl").html());this.$el.html(e)},initializeAutoComplete:function(){var e=this;this.collection.fetch({success:function(){$("#autocomplete").autocomplete({lookup:e.collection.toJSON(),onSelect:function(i){e.updateCurrentMovie(i.data)}}).keypress(function(i){i.keyCode===this.ENTER_KEY_CONSTANT&&e.updateCurrentMovie(suggestion.data)})}})},updateCurrentMovie:function(e){this.currentMovieId!=e&&(this.currentMovieId=e,this.trigger("movieSelected",e))}}),CinerchApp.MapView=Backbone.View.extend({initialize:function(){google.maps.event.addDomListener(window,"load",this.initMap()),this.id=0,this.movieLocationCache={}},initMap:function(){this.map=new CinerchApp.Map({mapCanvas:this.el})},render:function(){return this},updateMap:function(){var e=this;e.map.hasMarkers()&&e.map.deleteAllMarkers();var i=[];e.collection.each(function(e){var t=parseFloat(e.get("Longitude")),o=parseFloat(e.get("Latitude")),n=e.get("Name"),a=e.get("LocationId"),c=e.get("FunFacts");i.push({id:a,name:n,position:new google.maps.LatLng(o,t),funFacts:c})}),e.map.addMarkers(i)},updateMovieLocations:function(e){if(this.id!=e){var i=this.movieLocationCache[e],t=this;i?(t.collection.id=e,t.collection=i,t.updateMap()):(i=new CinerchApp.MovieLocationCollection([],{id:e}),i.fetch({success:function(){t.movieLocationCache[e]=i,t.collection=i,t.updateMap()},error:function(){t.collection.id=previousId,console.log("error fetching movie id"+e)}}))}}}),CinerchApp.MovieInfoView=Backbone.View.extend({el:"#movie_info",initialize:function(){this.listenTo(this.model,"change",this.render),0!=this.model.get("id")&&this.render()},render:function(){var e=_.template($("#movieInfo-tpl").html(),this.model.toJSON());return this.$el.html(e),this}}),CinerchApp.MainAppView=Backbone.View.extend({el:"#cinerch_app",initialize:function(e){this.movieSearchView=e.movieSearchView,this.movieInfoView=e.movieInfoView,this.mapView=e.mapView,this.listenTo(this.movieSearchView,"movieSelected",this.updateMovie)},updateMovie:function(e){var i=this.collection.get(e),t=!0,o=this;i?console.log("movie already exists in the collection"):(i=new CinerchApp.Movie({id:e}),i.fetch({success:function(){o.collection.add(i)},error:function(){alert("error"),t=!1}})),t&&(this.movieInfoView=new CinerchApp.MovieInfoView({model:i}),this.mapView.updateMovieLocations(e))}});